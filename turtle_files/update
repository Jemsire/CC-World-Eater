-- WORLD EATER: Turtle Update Script
-- Copies updated files from hub's disk drive
-- Turtles always update config files to stay in sync with hub

local drive_path = "/disk"
local has_disk = fs.exists(drive_path)
local update_to_root = not has_disk  -- If no disk, update directly to root

if not has_disk then
    print("⚠ No disk drive found - cannot update")
    print("  Turtle must be at hub to update")
    return
end

-- Function to report update completion to hub
local function report_update_complete()
    local hub_id = nil
    if fs.exists("/hub_id") then
        local hub_id_file = fs.open("/hub_id", "r")
        if hub_id_file then
            hub_id = hub_id_file.readAll()
            hub_id_file.close()
        end
    end
    
    if hub_id and rednet then
        -- Try to open rednet if not already open
        local rednet_open = false
        for _, side in pairs({'back', 'top', 'left', 'right'}) do
            if peripheral.getType(side) == 'modem' then
                rednet.open(side)
                rednet_open = true
                break
            end
        end
        
        if rednet_open then
            pcall(function()
                rednet.send(tonumber(hub_id), {}, 'update_complete')
                sleep(0.2)  -- Brief delay to ensure message is sent
            end)
        end
    end
end

print("========================================")
print("  World Eater Turtle Update")
print("========================================")
print("Copying files from hub disk drive...")
print("")

local updated_count = 0
local skipped_count = 0
local error_count = 0

-- List of files to copy from disk (all turtle files)
local turtle_files = {}
local disk_turtle_path = drive_path .. "/turtle_files"

if not fs.exists(disk_turtle_path) then
    print("ERROR: turtle_files directory not found on disk!")
    print("  Make sure hub has been updated first")
    return
end

-- Get all files from disk/turtle_files (excluding version.lua - downloaded from hub)
local function get_files_from_disk(dir_path, base_path)
    base_path = base_path or ""
    local files = {}
    
    for _, filename in pairs(fs.list(dir_path)) do
        -- Skip version.lua - it's downloaded from hub_files during updates
        if filename == "version.lua" then
            -- Skip this file
        else
            local full_path = fs.combine(dir_path, filename)
            local relative_path = base_path == "" and filename or (base_path .. "/" .. filename)
            
            if fs.isDir(full_path) then
                -- Recursively get files from subdirectory
                local sub_files = get_files_from_disk(full_path, relative_path)
                for _, sub_file in ipairs(sub_files) do
                    table.insert(files, sub_file)
                end
            else
                -- Add file to list
                table.insert(files, "turtle_files/" .. relative_path)
            end
        end
    end
    
    return files
end

turtle_files = get_files_from_disk(disk_turtle_path)

-- Also include turtle.lua if it exists
if fs.exists(drive_path .. "/turtle.lua") then
    table.insert(turtle_files, "turtle.lua")
end

if #turtle_files == 0 then
    print("No files found on disk to update!")
    return
end

print("Found " .. #turtle_files .. " files to update")
print("")

-- Copy each file from disk
for _, filepath in ipairs(turtle_files) do
    -- Yield to prevent "too long without yielding" error
    os.queueEvent("yield")
    os.pullEvent("yield")
    
    local source_path = drive_path .. "/" .. filepath
    local dest_path
    
    if update_to_root then
        -- Download directly to root, removing turtle_files/ prefix
        local root_path = string.gsub(filepath, "^turtle_files/", "")
        dest_path = "/" .. root_path
    else
        dest_path = drive_path .. "/" .. filepath
    end
    
    if not fs.exists(source_path) then
        print("  Skipping (not found): " .. filepath)
        skipped_count = skipped_count + 1
    else
        print("  Copying: " .. filepath)
        
        -- Yield before file operations
        os.queueEvent("yield")
        os.pullEvent("yield")
        
        -- Create directory if needed
        local dir = string.match(dest_path, "^(.-)[^/\\]*$")
        if dir and dir ~= "" and dir ~= "/" then
            fs.makeDir(dir)
        end
        
        -- Copy file
        local success, err = pcall(function()
            fs.copy(source_path, dest_path)
        end)
        
        if success then
            updated_count = updated_count + 1
        else
            print("    ERROR: " .. (err or "unknown error"))
            error_count = error_count + 1
        end
    end
end

-- Download version.lua from hub (always get latest version from hub)
print("")
print("Downloading version.lua from hub...")
local hub_version_path = drive_path .. "/hub_files/version.lua"
local turtle_version_path = update_to_root and "/version.lua" or (drive_path .. "/turtle_files/version.lua")

if fs.exists(hub_version_path) then
    -- Copy hub version to turtle
    local success, err = pcall(function()
        if update_to_root then
            fs.copy(hub_version_path, turtle_version_path)
        else
            -- Copy to disk first, will be copied to root by turtle.lua
            fs.copy(hub_version_path, turtle_version_path)
        end
    end)
    
    if success then
        print("  ✓ Downloaded version.lua from hub")
        updated_count = updated_count + 1
    else
        print("  ✗ Failed to download version.lua: " .. (err or "unknown error"))
        error_count = error_count + 1
    end
else
    print("  ⚠ Hub version.lua not found on disk (using existing turtle version if available)")
end

print("")
print("========================================")
print("  Update Summary")
print("========================================")
print("  Updated: " .. updated_count)
print("  Skipped: " .. skipped_count)
print("  Errors: " .. error_count)
print("")

if error_count > 0 then
    print("⚠ Some files failed to update!")
    print("  Check errors above")
    print("")
end

if update_to_root then
    -- Files already in root, just reboot
    print("Files updated directly to root (no disk access)")
    
    -- Ensure startup file exists so turtle boots properly
    if not fs.exists("/startup") and fs.exists("/startup.lua") then
        print("Creating startup file...")
        local startup_file = fs.open("/startup", "w")
        if startup_file then
            startup_file.write([[
-- Auto-generated startup file for World Eater Turtle
-- This file runs the turtle's main startup script

if fs.exists('/startup.lua') then
    shell.run('/startup.lua')
else
    print('startup.lua not found - run turtle.lua to initialize')
end
]])
            startup_file.close()
        end
    end
    
    -- Ensure update wrapper exists
    if not fs.exists("/update") then
        print("Creating update wrapper...")
        local update_wrapper = fs.open("/update", "w")
        if update_wrapper then
            update_wrapper.write([[
-- Update wrapper - runs the update script from root or disk
if fs.exists('/update.lua') then
    shell.run('/update.lua', ...)
elseif fs.exists('/disk/turtle_files/update') then
    shell.run('/disk/turtle_files/update', ...)
else
    print('Update script not found!')
end
]])
            update_wrapper.close()
        end
    end
    
    print("Rebooting to apply changes...")
    
    -- Report update completion to hub
    report_update_complete()
    
    -- Try to request re-initialization from hub before rebooting
    local hub_id = nil
    if fs.exists("/hub_id") then
        local hub_id_file = fs.open("/hub_id", "r")
        if hub_id_file then
            hub_id = hub_id_file.readAll()
            hub_id_file.close()
        end
    end
    
    if hub_id and rednet then
        print("Requesting re-initialization from hub...")
        local rednet_open = false
        for _, side in pairs({'back', 'top', 'left', 'right'}) do
            if peripheral.getType(side) == 'modem' then
                rednet.open(side)
                rednet_open = true
                break
            end
        end
        
        if rednet_open then
            pcall(function()
                rednet.send(tonumber(hub_id), {
                    action = 'reset_state',
                }, 'mastermine')
            end)
            sleep(0.5)
        end
    end
    
    print("Note: Turtle will automatically re-initialize with hub after reboot")
    sleep(2)
    os.reboot()
else
    -- Normal flow: copy files from disk to root
    print("Running turtle.lua to copy files to root...")
    
    -- Report update completion to hub before running turtle.lua
    report_update_complete()
    
    -- Yield before final operations
    os.queueEvent("yield")
    os.pullEvent("yield")
    
    sleep(1)
    
    -- Run turtle.lua to copy updated files from disk to root
    local turtle_lua_path = drive_path .. "/turtle.lua"
    if fs.exists(turtle_lua_path) then
        -- Use os.run to execute turtle.lua, which will handle copying files and rebooting
        -- We need to pass the hub_id, so we'll read it from /hub_id if it exists
        local hub_id = nil
        if fs.exists("/hub_id") then
            -- Yield before reading file
            os.queueEvent("yield")
            os.pullEvent("yield")
            
            local hub_id_file = fs.open("/hub_id", "r")
            if hub_id_file then
                hub_id = hub_id_file.readAll()
                hub_id_file.close()
            end
        end
        
        -- Try to request re-initialization from hub before rebooting
        -- This ensures the turtle gets the latest config after update
        if hub_id and rednet then
            print("Requesting re-initialization from hub...")
            -- Try to open rednet if not already open
            local rednet_open = false
            for _, side in pairs({'back', 'top', 'left', 'right'}) do
                if peripheral.getType(side) == 'modem' then
                    rednet.open(side)
                    rednet_open = true
                    break
                end
            end
            
            if rednet_open then
                -- Send reset request to hub (hub will detect session_id mismatch and re-initialize)
                pcall(function()
                    rednet.send(tonumber(hub_id), {
                        action = 'reset_state',  -- Custom action to trigger re-init
                    }, 'mastermine')
                end)
                sleep(0.5)  -- Brief delay to let message send
            end
        end
        
        print("Note: Turtle will automatically re-initialize with hub after reboot")
        print("      to receive the latest configuration.")
        sleep(2)
        
        -- Run turtle.lua to copy files and reboot
        os.run({}, turtle_lua_path, hub_id)
    else
        print("Error: turtle.lua not found on disk!")
        print("Update incomplete - turtle.lua missing")
        sleep(2)
    end
end