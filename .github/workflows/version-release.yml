name: Auto Version Release

on:
  push:
    branches:
      - main
      - master
    paths:
      - "hub_files/version.lua"
  workflow_dispatch:

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Parse version.lua
        id: version
        run: |
          VF="hub_files/version.lua"

          MAJOR=$(grep -v '^\s*--' "$VF" | grep -E 'major\s*=' | sed -E 's/.*major[[:space:]]*=[[:space:]]*([0-9]+).*/\1/')
          MINOR=$(grep -v '^\s*--' "$VF" | grep -E 'minor\s*=' | sed -E 's/.*minor[[:space:]]*=[[:space:]]*([0-9]+).*/\1/')
          HOTFIX=$(grep -v '^\s*--' "$VF" | grep -E 'hotfix\s*=' | sed -E 's/.*hotfix[[:space:]]*=[[:space:]]*([0-9]+).*/\1/')

          VERSION="${MAJOR}.${MINOR}.${HOTFIX}"
          TAG="v${VERSION}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Parsed version: ${VERSION}, tag: ${TAG}"

      - name: Determine previous tag
        id: prev
        run: |
          PREV=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "previous=${PREV}" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREV"

      - name: Generate changelog
        run: |
          OLD_TAG="${{ steps.prev.outputs.previous }}"

          if [ -z "$OLD_TAG" ]; then
            git log --pretty=format:"- %s (%h) — by %an" > CHANGELOG.md
          else
            git log "$OLD_TAG"..HEAD --pretty=format:"- %s (%h) — by %an" > CHANGELOG.md
          fi

      - name: Create or Update Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"

          CHANGELOG_CONTENT=$(cat CHANGELOG.md)

          # Build notes without heredoc
          NOTES=$(printf "### Version %s\n\n#### Changes\n%s\n\nAutomatically generated from commit history, including authors.\n" \
            "$VERSION" "$CHANGELOG_CONTENT")

          RELEASE_ID=$(gh api repos/${{ github.repository }}/releases/tags/${TAG} --jq '.id' 2>/dev/null || echo "")

          if [ -z "$RELEASE_ID" ]; then
            gh release create "$TAG" --title "v${VERSION}" --notes "$NOTES" --latest
          else
            gh release edit "$TAG" --title "v${VERSION}" --notes "$NOTES" --latest
          fi
