name: Auto Version Release

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'hub_files/version.lua'
  workflow_dispatch: # Allow manual triggering

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Parse version from version.lua
        id: parse_version
        run: |
          # Read the version.lua file and extract version numbers
          VERSION_FILE="hub_files/version.lua"
          
          # Extract major, minor, and hotfix using sed (more portable than grep -P)
          MAJOR=$(sed -n 's/.*major\s*=\s*\([0-9]*\).*/\1/p' "$VERSION_FILE" | head -n1)
          MINOR=$(sed -n 's/.*minor\s*=\s*\([0-9]*\).*/\1/p' "$VERSION_FILE" | head -n1)
          HOTFIX=$(sed -n 's/.*hotfix\s*=\s*\([0-9]*\).*/\1/p' "$VERSION_FILE" | head -n1)
          
          # Default to 0 if not found
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          HOTFIX=${HOTFIX:-0}
          
          # Validate that we got numeric values
          if ! [[ "$MAJOR" =~ ^[0-9]+$ ]] || ! [[ "$MINOR" =~ ^[0-9]+$ ]] || ! [[ "$HOTFIX" =~ ^[0-9]+$ ]]; then
            echo "Error: Invalid version numbers parsed. MAJOR=$MAJOR, MINOR=$MINOR, HOTFIX=$HOTFIX"
            exit 1
          fi
          
          VERSION="${MAJOR}.${MINOR}.${HOTFIX}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Parsed version: ${VERSION}"
      
      - name: Create or update release
        run: |
          VERSION="${{ steps.parse_version.outputs.version }}"
          TAG="v${VERSION}"
          
          # Check if release already exists
          RELEASE_ID=$(gh api repos/${{ github.repository }}/releases/tags/${TAG} --jq '.id' 2>/dev/null || echo "")
          
          if [ -z "$RELEASE_ID" ]; then
            # Create new release
            gh release create "${TAG}" \
              --title "v${VERSION}" \
              --notes "Auto-generated release from version.lua

              Version: **${VERSION}**
              
              This release was automatically created from \`hub_files/version.lua\`." \
              --latest
          else
            # Update existing release
            gh release edit "${TAG}" \
              --title "v${VERSION}" \
              --notes "Auto-generated release from version.lua

              Version: **${VERSION}**
              
              This release was automatically created from \`hub_files/version.lua\`." \
              --latest
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

